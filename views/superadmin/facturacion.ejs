<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturación del Sistema - RestaurantPro</title>
    <link href="/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/vendor/bootstrap-icons/bootstrap-icons.css">
</head>
<body style="background-color: #f8f9fa;">
    <%- include('../partials/navbar_superadmin') %>

    <div class="container mt-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>Facturación del Sistema</h5>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNuevaFactura">
                    <i class="bi bi-plus-circle me-1"></i> Nueva Factura
                </button>
            </div>
            <div class="card-body">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Restaurante</th>
                            <th>Período</th>
                            <th>Plan</th>
                            <th>Monto</th>
                            <th>Estado</th>
                            <th>Vencimiento</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% facturas.forEach(f => { %>
                        <tr>
                            <td><strong>#<%= f.id %></strong></td>
                            <td><%= f.restaurante_nombre %></td>
                            <td><%= new Date(f.periodo_inicio).toLocaleDateString() %> - <%= new Date(f.periodo_fin).toLocaleDateString() %></td>
                            <td><span class="badge bg-info"><%= f.plan %></span></td>
                            <td>$<%= Number(f.monto).toFixed(2) %></td>
                            <td>
                                <span class="badge bg-<%= f.estado === 'pagada' ? 'success' : f.estado === 'pendiente' ? 'warning' : 'danger' %>">
                                    <%= f.estado %>
                                </span>
                            </td>
                            <td><%= new Date(f.fecha_vencimiento).toLocaleDateString() %></td>
                            <td>
                                <% if (f.estado === 'pendiente') { %>
                                <button class="btn btn-sm btn-outline-success" onclick="marcarPagada(<%= f.id %>)">
                                    <i class="bi bi-check-circle"></i> Marcar Pagada
                                </button>
                                <% } %>
                            </td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Nueva Factura -->
    <div class="modal fade" id="modalNuevaFactura" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Generar Factura</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formNuevaFactura">
                        <div class="mb-3">
                            <label class="form-label">Restaurante</label>
                            <select class="form-select" name="restaurante_id" required>
                                <% restaurantes.forEach(r => { %>
                                <option value="<%= r.id %>"><%= r.nombre %> (<%= r.plan %>)</option>
                                <% }); %>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Período Inicio</label>
                            <input type="date" class="form-control" name="periodo_inicio" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Período Fin</label>
                            <input type="date" class="form-control" name="periodo_fin" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Monto</label>
                            <input type="number" step="0.01" class="form-control" name="monto" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Fecha Vencimiento</label>
                            <input type="date" class="form-control" name="fecha_vencimiento" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="generarFactura()">Generar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/vendor/jquery/jquery.min.js"></script>
    <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script>
        async function marcarPagada(id) {
            if (!confirm('¿Marcar esta factura como pagada?')) return;

            try {
                const response = await fetch('/superadmin/facturacion/' + id + '/pagar', {
                    method: 'PUT'
                });

                if (response.ok) {
                    alert('Factura marcada como pagada');
                    location.reload();
                } else {
                    alert('Error al actualizar factura');
                }
            } catch (error) {
                alert('Error al actualizar factura');
            }
        }

        async function generarFactura() {
            const form = document.getElementById('formNuevaFactura');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            try {
                const response = await fetch('/superadmin/facturacion', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('Factura generada exitosamente');
                    location.reload();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (error) {
                alert('Error al generar factura');
            }
        }
    </script>
</body>
</html>
