<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes de Ventas - RestaurantPro</title>
    <link href="/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/vendor/bootstrap-icons/bootstrap-icons.css">
    <style>
        html, body { 
            height: 100%; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        
        body { 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column;
            background-color: #f8f9fa;
        }
        
        /* Cards de estadísticas */
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            height: 100%;
        }
        
        .stat-card:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        
        .stat-card.primary { border-left-color: #3498db; }
        .stat-card.success { border-left-color: #2ecc71; }
        .stat-card.info { border-left-color: #16a085; }
        .stat-card.warning { border-left-color: #f39c12; }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }
        
        .stat-icon.primary { background: rgba(52, 152, 219, 0.1); color: #3498db; }
        .stat-icon.success { background: rgba(46, 204, 113, 0.1); color: #2ecc71; }
        .stat-icon.info { background: rgba(22, 160, 133, 0.1); color: #16a085; }
        .stat-icon.warning { background: rgba(243, 156, 18, 0.1); color: #f39c12; }
        
        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 0.5rem 0 0.25rem 0;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }
        
        /* Filtros */
        .filters-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }
        
        .filter-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .form-control, .form-select {
            border-radius: 4px;
            border: 1px solid #dee2e6;
            padding: 0.625rem 0.875rem;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.15);
        }
        
        .btn {
            border-radius: 4px;
            padding: 0.625rem 1.25rem;
            font-weight: 500;
        }
        
        .btn-primary {
            background: #3498db;
            border-color: #3498db;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            border-color: #2980b9;
        }
        
        .btn-success {
            background: #2ecc71;
            border-color: #2ecc71;
        }
        
        .btn-success:hover {
            background: #27ae60;
            border-color: #27ae60;
        }
        
        /* Tabla */
        .table-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        
        .table {
            margin-bottom: 0;
        }
        
        .table thead th {
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            color: #2c3e50;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 1rem 0.75rem;
            white-space: nowrap;
        }
        
        .table tbody tr {
            transition: background-color 0.2s;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .table tbody td {
            padding: 1rem 0.75rem;
            vertical-align: middle;
        }
        
        .table tfoot {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .badge {
            padding: 0.5rem 0.875rem;
            font-weight: 500;
            border-radius: 4px;
        }
        
        .btn-action {
            width: 32px;
            height: 32px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        
        /* Paginación */
        .pagination {
            margin: 0;
        }
        
        .page-link {
            border-radius: 4px;
            margin: 0 0.25rem;
            border: 1px solid #dee2e6;
            color: #2c3e50;
            padding: 0.5rem 0.875rem;
        }
        
        .page-item.active .page-link {
            background: #3498db;
            border-color: #3498db;
        }
        
        .page-link:hover {
            background: #f8f9fa;
            border-color: #3498db;
            color: #3498db;
        }
        
        /* Alertas */
        .custom-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 320px;
            max-width: 400px;
            padding: 1rem 1.25rem;
            border-radius: 8px;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease-out;
        }
        
        .custom-alert.success {
            background: #d4edda;
            border-left: 4px solid #2ecc71;
            color: #155724;
        }
        
        .custom-alert.error {
            background: #f8d7da;
            border-left: 4px solid #e74c3c;
            color: #721c24;
        }
        
        .custom-alert.warning {
            background: #fff3cd;
            border-left: 4px solid #f39c12;
            color: #856404;
        }
        
        @keyframes slideIn {
            from { 
                transform: translateX(120%);
                opacity: 0;
            }
            to { 
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .stat-card {
                margin-bottom: 1rem;
            }
            
            .filters-card {
                padding: 1rem;
            }
            
            .table-card {
                padding: 0.5rem;
                overflow-x: auto;
            }
            
            .table {
                font-size: 0.875rem;
            }
            
            .table thead th,
            .table tbody td {
                padding: 0.75rem 0.5rem;
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
            
            .stat-icon {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }
            
            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }
            
            .custom-alert {
                min-width: 280px;
                max-width: calc(100vw - 40px);
            }
        }
        
        @media (max-width: 576px) {
            .table-responsive {
                border-radius: 8px;
            }
            
            .filter-label {
                font-size: 0.8rem;
            }
            
            .form-control, .form-select {
                font-size: 0.875rem;
                padding: 0.5rem 0.75rem;
            }
        }
    </style>
</head>
<body>
    <%- include('partials/navbar') %>


    <main class="flex-grow-1 py-4">
        <div class="container-fluid px-3 px-md-4">
            
            <!-- Título -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1" style="color: var(--primary-color); font-weight: 700;">
                        <i class="bi bi-graph-up-arrow me-2"></i>Reportes de Ventas
                    </h2>
                    <p class="text-muted mb-0">Análisis detallado de tus ventas y estadísticas</p>
                </div>
            </div>

            <!-- Tarjetas de Estadísticas -->
            <div class="row g-3 mb-4">
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="stat-card primary">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="stat-label">Total Facturas</div>
                                <div class="stat-value"><%= estadisticas.total_facturas %></div>
                                <small class="text-muted">Facturas registradas</small>
                            </div>
                            <div class="stat-icon primary">
                                <i class="bi bi-receipt"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="stat-card success">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="stat-label">Total Ventas</div>
                                <div class="stat-value">$<%= Number(estadisticas.total_ventas).toLocaleString('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) %></div>
                                <small class="text-muted">Ingresos totales</small>
                            </div>
                            <div class="stat-icon success">
                                <i class="bi bi-cash-stack"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="stat-card info">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="stat-label">Ticket Promedio</div>
                                <div class="stat-value">$<%= Number(estadisticas.ticket_promedio).toLocaleString('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) %></div>
                                <small class="text-muted">Por factura</small>
                            </div>
                            <div class="stat-icon info">
                                <i class="bi bi-graph-up"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="stat-card warning">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="stat-label">Venta Máxima</div>
                                <div class="stat-value">$<%= Number(estadisticas.venta_maxima).toLocaleString('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) %></div>
                                <small class="text-muted">Mayor venta</small>
                            </div>
                            <div class="stat-icon warning">
                                <i class="bi bi-trophy"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Filtros -->
            <div class="filters-card">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-funnel-fill me-2" style="color: var(--secondary-color); font-size: 1.25rem;"></i>
                    <h5 class="mb-0" style="color: var(--primary-color); font-weight: 600;">Filtros de Búsqueda</h5>
                </div>
                
                <div class="row g-3">
                    <div class="col-12 col-md-6 col-lg-3">
                        <label class="filter-label">
                            <i class="bi bi-calendar-event me-1"></i>Fecha Desde
                        </label>
                        <input type="date" id="fechaDesde" class="form-control" value="<%= filtros.desde || '' %>">
                    </div>
                    
                    <div class="col-12 col-md-6 col-lg-3">
                        <label class="filter-label">
                            <i class="bi bi-calendar-check me-1"></i>Fecha Hasta
                        </label>
                        <input type="date" id="fechaHasta" class="form-control" value="<%= filtros.hasta || '' %>">
                    </div>
                    
                    <div class="col-12 col-md-6 col-lg-2">
                        <label class="filter-label">
                            <i class="bi bi-credit-card me-1"></i>Forma de Pago
                        </label>
                        <select id="formaPagoFiltro" class="form-select">
                            <option value="todos">Cargando...</option>
                        </select>
                    </div>
                    
                    <div class="col-12 col-md-6 col-lg-4">
                        <label class="filter-label">
                            <i class="bi bi-search me-1"></i>Buscar
                        </label>
                        <input type="text" id="buscarVentas" class="form-control" placeholder="Cliente o # factura" value="<%= filtros.q || '' %>">
                    </div>
                </div>
                
                <div class="row g-2 mt-3">
                    <div class="col-12 col-md-auto">
                        <button class="btn btn-primary w-100" id="filtrarVentas">
                            <i class="bi bi-funnel me-2"></i>Aplicar Filtros
                        </button>
                    </div>
                    <div class="col-12 col-md-auto">
                        <button class="btn btn-outline-secondary w-100" id="limpiarFiltros">
                            <i class="bi bi-x-circle me-2"></i>Limpiar
                        </button>
                    </div>
                    <div class="col-12 col-md-auto">
                        <button class="btn btn-success w-100" id="exportarVentas">
                            <i class="bi bi-file-earmark-excel me-2"></i>Exportar Excel
                        </button>
                    </div>
                    <div class="col-12 col-md-auto">
                        <div class="dropdown">
                            <button class="btn btn-outline-info dropdown-toggle w-100" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-clock-history me-2"></i>Presets
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" data-preset="hoy"><i class="bi bi-calendar-day me-2"></i>Hoy</a></li>
                                <li><a class="dropdown-item" href="#" data-preset="ayer"><i class="bi bi-calendar-minus me-2"></i>Ayer</a></li>
                                <li><a class="dropdown-item" href="#" data-preset="semana"><i class="bi bi-calendar-week me-2"></i>Esta Semana</a></li>
                                <li><a class="dropdown-item" href="#" data-preset="mes"><i class="bi bi-calendar-month me-2"></i>Este Mes</a></li>
                                <li><a class="dropdown-item" href="#" data-preset="mes-anterior"><i class="bi bi-calendar3 me-2"></i>Mes Anterior</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Tabla de Ventas -->
            <div class="table-card">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <div class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        <%= textoPaginacion %>
                    </div>
                    <div>
                        <select id="registrosPorPagina" class="form-select form-select-sm">
                            <option value="25" <%= paginacion.registrosPorPagina === 25 ? 'selected' : '' %>>25 por página</option>
                            <option value="50" <%= paginacion.registrosPorPagina === 50 ? 'selected' : '' %>>50 por página</option>
                            <option value="100" <%= paginacion.registrosPorPagina === 100 ? 'selected' : '' %>>100 por página</option>
                        </select>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th><i class="bi bi-hash me-1"></i>Factura</th>
                                <th><i class="bi bi-calendar3 me-1"></i>Fecha</th>
                                <th><i class="bi bi-person me-1"></i>Cliente</th>
                                <th><i class="bi bi-credit-card me-1"></i>Pago</th>
                                <th class="text-end"><i class="bi bi-currency-dollar me-1"></i>Total</th>
                                <th class="text-center"><i class="bi bi-gear me-1"></i>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (ventas.length === 0) { %>
                                <tr>
                                    <td colspan="6" class="text-center py-5">
                                        <div class="text-muted">
                                            <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                                            <p class="mt-3 mb-0">No se encontraron ventas con los filtros seleccionados</p>
                                        </div>
                                    </td>
                                </tr>
                            <% } else { %>
                                <% ventas.forEach(function(venta) { %>
                                    <tr>
                                        <td><strong class="text-primary">#<%= venta.id %></strong></td>
                                        <td><%= new Date(venta.fecha).toLocaleString('es-CO', { dateStyle: 'short', timeStyle: 'short' }) %></td>
                                        <td><%= venta.cliente_nombre %></td>
                                        <td>
                                            <% const formaPago = venta.forma_pago.charAt(0).toUpperCase() + venta.forma_pago.slice(1); %>
                                            <% const badgeClass = venta.forma_pago === 'efectivo' ? 'bg-success' : venta.forma_pago === 'transferencia' ? 'bg-info' : venta.forma_pago === 'tarjeta' ? 'bg-primary' : 'bg-warning'; %>
                                            <span class="badge <%= badgeClass %>"><%= formaPago %></span>
                                        </td>
                                        <td class="text-end"><strong>$<%= Number(venta.total).toLocaleString('es-CO', { minimumFractionDigits: 2 }) %></strong></td>
                                        <td class="text-center">
                                            <button class="btn btn-outline-info btn-action btn-detalles me-1" 
                                                    data-factura-id="<%= venta.id %>"
                                                    data-bs-toggle="tooltip" 
                                                    title="Ver detalles">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-primary btn-action btn-reimprimir" 
                                                    data-factura-id="<%= venta.id %>"
                                                    data-bs-toggle="tooltip" 
                                                    title="Reimprimir">
                                                <i class="bi bi-printer"></i>
                                            </button>
                                        </td>
                                    </tr>
                                <% }); %>
                            <% } %>
                        </tbody>
                        <% if (ventas.length > 0) { %>
                        <tfoot>
                            <tr class="table-success">
                                <td colspan="4" class="text-end"><strong>Total Efectivo:</strong></td>
                                <td colspan="2" class="text-end"><strong>$<%= Number(totales.efectivo).toLocaleString('es-CO', { minimumFractionDigits: 2 }) %></strong></td>
                            </tr>
                            <tr class="table-info">
                                <td colspan="4" class="text-end"><strong>Total Transferencia:</strong></td>
                                <td colspan="2" class="text-end"><strong>$<%= Number(totales.transferencia).toLocaleString('es-CO', { minimumFractionDigits: 2 }) %></strong></td>
                            </tr>
                            <tr class="table-primary">
                                <td colspan="4" class="text-end"><strong>Total Tarjeta:</strong></td>
                                <td colspan="2" class="text-end"><strong>$<%= Number(totales.tarjeta).toLocaleString('es-CO', { minimumFractionDigits: 2 }) %></strong></td>
                            </tr>
                            <tr class="table-warning">
                                <td colspan="4" class="text-end"><h5 class="mb-0">Total General:</h5></td>
                                <td colspan="2" class="text-end"><h5 class="mb-0">$<%= Number(totales.general).toLocaleString('es-CO', { minimumFractionDigits: 2 }) %></h5></td>
                            </tr>
                        </tfoot>
                        <% } %>
                    </table>
                </div>

                <!-- Paginación -->
                <% if (paginacion.totalPaginas > 1) { %>
                    <div class="mt-4 d-flex justify-content-center">
                        <%- paginacionHTML %>
                    </div>
                <% } %>
            </div>

        </div>
    </main>


    <!-- Modal para mostrar facturas -->
    <div class="modal fade" id="facturaModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content" style="border-radius: 12px; border: none;">
                <div class="modal-header" style="background: var(--secondary-color); color: white; border-radius: 12px 12px 0 0;">
                    <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>Factura</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <iframe id="facturaFrame" style="width: 100%; height: 600px; border: none;"></iframe>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i>Cerrar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="imprimirFactura()">
                        <i class="bi bi-printer me-2"></i>Imprimir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para detalles de factura -->
    <div class="modal fade" id="detallesModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content" style="border-radius: 12px; border: none;">
                <div class="modal-header" style="background: var(--info-color); color: white; border-radius: 12px 12px 0 0;">
                    <h5 class="modal-title"><i class="bi bi-info-circle me-2"></i>Detalles de Factura</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3"><i class="bi bi-person-circle me-2"></i>Información del Cliente</h6>
                            <div id="detallesCliente"></div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3"><i class="bi bi-receipt-cutoff me-2"></i>Información de la Factura</h6>
                            <div id="detallesFactura"></div>
                        </div>
                    </div>
                    <h6 class="text-primary mb-3"><i class="bi bi-cart-check me-2"></i>Productos</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Producto</th>
                                    <th class="text-end">Cantidad</th>
                                    <th>Unidad</th>
                                    <th class="text-end">Precio Unit.</th>
                                    <th class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody id="detallesProductos"></tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="4" class="text-end"><strong>Total:</strong></td>
                                    <td class="text-end"><strong id="detallesTotal"></strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <%- include('partials/footer') %>


    <script src="/vendor/jquery/jquery.min.js"></script>
    <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script>
        const facturaModal = new bootstrap.Modal(document.getElementById('facturaModal'));
        const detallesModal = new bootstrap.Modal(document.getElementById('detallesModal'));
        
        // Cargar medios de pago para el filtro
        async function cargarMediosPagoFiltro() {
            try {
                const resp = await fetch('/configuracion/medios-pago/activos');
                const medios = await resp.json();
                
                const select = document.getElementById('formaPagoFiltro');
                if (!select) return;
                
                const formaPagoActual = '<%= filtros.forma_pago || "todos" %>';
                
                let html = '<option value="todos">Todos</option>';
                medios.forEach(medio => {
                    const selected = formaPagoActual === medio.codigo ? 'selected' : '';
                    html += `<option value="${medio.codigo}" ${selected}>${medio.nombre}</option>`;
                });
                html += `<option value="mixto" ${formaPagoActual === 'mixto' ? 'selected' : ''}>Mixto</option>`;
                
                select.innerHTML = html;
                
            } catch (error) {
                console.error('Error al cargar medios de pago:', error);
                const select = document.getElementById('formaPagoFiltro');
                if (select) {
                    const formaPagoActual = '<%= filtros.forma_pago || "todos" %>';
                    select.innerHTML = `
                        <option value="todos">Todos</option>
                        <option value="efectivo" ${formaPagoActual === 'efectivo' ? 'selected' : ''}>Efectivo</option>
                        <option value="transferencia" ${formaPagoActual === 'transferencia' ? 'selected' : ''}>Transferencia</option>
                        <option value="tarjeta" ${formaPagoActual === 'tarjeta' ? 'selected' : ''}>Tarjeta</option>
                        <option value="mixto" ${formaPagoActual === 'mixto' ? 'selected' : ''}>Mixto</option>
                    `;
                }
            }
        }
        
        // Ejecutar al cargar la página
        cargarMediosPagoFiltro();
        
        function mostrarAlerta(mensaje, tipo = 'success') {
            const alertaDiv = document.createElement('div');
            alertaDiv.className = `custom-alert ${tipo}`;
            alertaDiv.innerHTML = `
                <i class="bi ${tipo === 'success' ? 'bi-check-circle-fill' : 
                              tipo === 'error' ? 'bi-x-circle-fill' : 
                              'bi-exclamation-triangle-fill'}" style="font-size: 1.5rem;"></i>
                <div class="flex-grow-1">${mensaje}</div>
                <button type="button" class="btn-close btn-close-white" onclick="this.parentElement.remove()"></button>
            `;
            document.body.appendChild(alertaDiv);
            setTimeout(() => alertaDiv.remove(), 5000);
        }

        function mostrarFactura(id) {
            document.getElementById('facturaFrame').src = `/api/facturas/${id}/imprimir?embed=1`;
            document.querySelector('#facturaModal .modal-title').innerHTML = `<i class="bi bi-receipt me-2"></i>Factura #${id}`;
            facturaModal.show();
        }

        function mostrarDetalles(id) {
            $.ajax({
                url: `/api/facturas/${id}/detalles`,
                success: function(data) {
                    $('#detallesCliente').html(`
                        <p class="mb-2"><strong>Nombre:</strong> ${data.cliente.nombre}</p>
                        <p class="mb-2"><strong>Dirección:</strong> ${data.cliente.direccion || 'No especificada'}</p>
                        <p class="mb-0"><strong>Teléfono:</strong> ${data.cliente.telefono || 'No especificado'}</p>
                    `);

                    $('#detallesFactura').html(`
                        <p class="mb-2"><strong>Factura #:</strong> ${data.factura.id}</p>
                        <p class="mb-2"><strong>Fecha:</strong> ${new Date(data.factura.fecha).toLocaleString()}</p>
                        <p class="mb-2"><strong>Forma de Pago:</strong> ${data.factura.forma_pago.charAt(0).toUpperCase() + data.factura.forma_pago.slice(1)}</p>
                        ${
                            Array.isArray(data.pagos) && data.pagos.length > 0
                            ? `
                                <div class="mt-2">
                                    <strong>Pagos:</strong>
                                    <ul class="mb-0 mt-1">
                                        ${data.pagos.map(p => `
                                            <li>
                                                <strong>${(p.metodo||'').charAt(0).toUpperCase() + (p.metodo||'').slice(1)}:</strong>
                                                $${Number(p.monto||0).toFixed(2)}
                                                ${p.referencia ? `<span class="text-muted">(${p.referencia})</span>` : ''}
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                              `
                            : ``
                        }
                    `);

                    const tbody = $('#detallesProductos');
                    tbody.empty();
                    let totalGeneral = 0;
                    
                    data.productos.forEach(producto => {
                        const cantidad = producto.cantidad || 0;
                        const precio = producto.precio || 0;
                        const subtotal = producto.subtotal || 0;
                        totalGeneral += subtotal;
                        
                        tbody.append(`
                            <tr>
                                <td>${producto.nombre}</td>
                                <td class="text-end">${cantidad.toFixed(2)}</td>
                                <td>${producto.unidad || 'N/A'}</td>
                                <td class="text-end">$${precio.toFixed(2)}</td>
                                <td class="text-end">$${subtotal.toFixed(2)}</td>
                            </tr>
                        `);
                    });

                    $('#detallesTotal').text(`$${totalGeneral.toFixed(2)}`);
                    detallesModal.show();
                },
                error: function() {
                    mostrarAlerta('Error al cargar los detalles de la factura', 'error');
                }
            });
        }

        function imprimirFactura() {
            document.getElementById('facturaFrame').contentWindow.print();
        }


        function aplicarFiltros() {
            const desde = document.getElementById('fechaDesde').value;
            const hasta = document.getElementById('fechaHasta').value;
            const formaPago = document.getElementById('formaPagoFiltro').value;
            const q = document.getElementById('buscarVentas').value.trim();
            
            if (!desde || !hasta) {
                mostrarAlerta('Por favor seleccione ambas fechas', 'warning');
                return;
            }
            
            const params = new URLSearchParams();
            params.set('desde', desde);
            params.set('hasta', hasta);
            if (formaPago && formaPago !== 'todos') params.set('forma_pago', formaPago);
            if (q) params.set('q', q);
            
            window.location.href = `/ventas?${params.toString()}`;
        }

        document.getElementById('filtrarVentas').addEventListener('click', aplicarFiltros);
        document.getElementById('buscarVentas').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') aplicarFiltros();
        });

        document.getElementById('limpiarFiltros').addEventListener('click', function() {
            window.location.href = '/ventas';
        });

        document.getElementById('exportarVentas').addEventListener('click', function() {
            const desde = document.getElementById('fechaDesde').value;
            const hasta = document.getElementById('fechaHasta').value;
            const formaPago = document.getElementById('formaPagoFiltro').value;
            const q = document.getElementById('buscarVentas').value.trim();
            
            const params = new URLSearchParams();
            if (desde && hasta) {
                params.set('desde', desde);
                params.set('hasta', hasta);
            }
            if (formaPago && formaPago !== 'todos') params.set('forma_pago', formaPago);
            if (q) params.set('q', q);
            
            window.open(`/ventas/export?${params.toString()}`, '_blank');
        });

        document.getElementById('registrosPorPagina').addEventListener('change', function() {
            const limit = this.value;
            const params = new URLSearchParams(window.location.search);
            params.set('limit', limit);
            params.delete('page');
            window.location.href = `/ventas?${params.toString()}`;
        });

        document.querySelectorAll('[data-preset]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const preset = this.getAttribute('data-preset');
                const hoy = new Date();
                let desde, hasta;
                
                switch(preset) {
                    case 'hoy':
                        desde = hasta = hoy.toISOString().split('T')[0];
                        break;
                    case 'ayer':
                        const ayer = new Date(hoy);
                        ayer.setDate(ayer.getDate() - 1);
                        desde = hasta = ayer.toISOString().split('T')[0];
                        break;
                    case 'semana':
                        const inicioSemana = new Date(hoy);
                        inicioSemana.setDate(hoy.getDate() - hoy.getDay());
                        desde = inicioSemana.toISOString().split('T')[0];
                        hasta = hoy.toISOString().split('T')[0];
                        break;
                    case 'mes':
                        desde = new Date(hoy.getFullYear(), hoy.getMonth(), 1).toISOString().split('T')[0];
                        hasta = hoy.toISOString().split('T')[0];
                        break;
                    case 'mes-anterior':
                        const mesAnterior = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
                        desde = mesAnterior.toISOString().split('T')[0];
                        const finMesAnterior = new Date(hoy.getFullYear(), hoy.getMonth(), 0);
                        hasta = finMesAnterior.toISOString().split('T')[0];
                        break;
                }
                
                document.getElementById('fechaDesde').value = desde;
                document.getElementById('fechaHasta').value = hasta;
                aplicarFiltros();
            });
        });

        (function initFiltros() {
            const params = new URLSearchParams(window.location.search);
            const desde = params.get('desde');
            const hasta = params.get('hasta');
            const formaPago = params.get('forma_pago');
            const q = params.get('q');
            
            if (desde) document.getElementById('fechaDesde').value = desde;
            if (hasta) document.getElementById('fechaHasta').value = hasta;
            if (formaPago) document.getElementById('formaPagoFiltro').value = formaPago;
            if (q) document.getElementById('buscarVentas').value = q;
            
            if (!desde || !hasta) {
                const hoy = new Date();
                const hace30 = new Date();
                hace30.setDate(hace30.getDate() - 30);
                
                if (!desde) document.getElementById('fechaDesde').value = hace30.toISOString().split('T')[0];
                if (!hasta) document.getElementById('fechaHasta').value = hoy.toISOString().split('T')[0];
            }
        })();

        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(el => new bootstrap.Tooltip(el));

        document.querySelectorAll('.btn-reimprimir').forEach(button => {
            button.addEventListener('click', function() {
                mostrarFactura(this.getAttribute('data-factura-id'));
            });
        });

        document.querySelectorAll('.btn-detalles').forEach(button => {
            button.addEventListener('click', function() {
                mostrarDetalles(this.getAttribute('data-factura-id'));
            });
        });
    </script>
</body>
</html>
